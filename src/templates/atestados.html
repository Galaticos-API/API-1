<!-- templates/atestados.html -->
{% extends "base.html" %} {% block title %}Atestados{% endblock %} {% block content %}
<div class="content">
  <h1>Atestados</h1>
  <hr />
  <h4>Envio de documento</h4>
  <form class="formAtestado row my-3" id="formAtestadoJ" method="POST" enctype="multipart/form-data">
    <div class="col-md-4 col-12">
      <label for="inputGroupFile02" class="form-label">Selecionar arquivo</label>
      <div class="input-group mb-3">
        <input class="form-control" type="file" name="file" id="file" accept=".pdf" required />
      </div>
    </div>
    <div class="col-md-4 col-6">
      <label for="duration" class="form-label">Duração do Atestado (em dias)</label>
      <div class="input-group">
        <input type="text" class="form-control" name="duration" id="duration" />
      </div>
    </div>
    <div class="col-md-4 col-6">
      <label for="filetype" class="form-label">Tipo de atestado</label>
      <div class="input-group mb-3">
        <select class="form-select" id="filetype" name="filetype">
          <option value="undefined">Selecione um tipo</option>
          <option value="TIPO1">TIPO1</option>
          <option value="TIPO2">TIPO2</option>
          <option value="TIPO3">TIPO3</option>
        </select>
      </div>
    </div>
    <button class="btn btn-outline-primary col-md-2 col-4 mx-auto mb-6" id="botao-do-submit" type="submit">Enviar</button>
  </form>

  <hr />
  <h4>Atestados enviados</h4>
  <nav class="search-container mb-3 d-flex align-items-center gap-2">
    <input type="number" id="search" placeholder="Buscar por RA..." oninput="filterDocuments()" />
    <select class="form-select w-auto" id="category" onchange="filterDocuments()">
      <option value="durationasc">Menor Duração</option>
      <option value="durationdesc">Maior Duração</option>
      <option value="dateolder">Mais Antigo</option>
      <option value="datenewer">Mais Recente</option>
    </select>
    <button class="btn btn-outline-primary ms-auto" id="btn-metricas" type="button" data-bs-toggle="modal" data-bs-target="#modalMetricas">Relatório</button>
  </nav>

  <table id="atestadosTable" class="table table-striped px-0">
    <thead>
      <tr>
        <th>Nome do Documento</th>
        <th>RA do Aluno</th>
        <th>Data de Envio</th>
        <th>Duração do Atestado</th>
        <th>Tipo de Atestado</th>
      </tr>
    </thead>
    <tbody>
      <!-- Os dados dos atestados serão inseridos aqui -->
    </tbody>
  </table>

  <!-- Modal Métricas -->
  <div class="modal fade" id="modalMetricas" tabindex="-1" aria-labelledby="modalMetricasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #366341; color: #fff;">
          <h5 class="modal-title" id="modalMetricasLabel">Métricas dos Atestados</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar" style="filter: invert(1);"></button>
        </div>
        <div class="modal-body">
          <div id="metricasConteudo">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    function filterDocuments() {
      let searchInput = document.getElementById("search").value.toLowerCase();
      let categoryFilter = document.getElementById("category").value;
      let rows = document.querySelectorAll("#atestadosTable tbody tr");

      // Converte as linhas para um array para facilitar a ordenação
      let rowsArray = Array.from(rows);

      // Filtro de busca por RA
      rowsArray.forEach((row) => {
        let ra = row.cells[1].textContent.toLowerCase();
        row.style.display = ra.includes(searchInput) ? "" : "none";
      });

      // Ordenação com base no filtro selecionado
      if (categoryFilter === "nameaz") {
        rowsArray.sort((a, b) => a.cells[0].textContent.localeCompare(b.cells[0].textContent));
      } else if (categoryFilter === "nameza") {
        rowsArray.sort((a, b) => b.cells[0].textContent.localeCompare(a.cells[0].textContent));
      } else if (categoryFilter === "dateolder") {
        rowsArray.sort((a, b) => new Date(a.cells[2].textContent) - new Date(b.cells[2].textContent));
      } else if (categoryFilter === "datenewer") {
        rowsArray.sort((a, b) => new Date(b.cells[2].textContent) - new Date(a.cells[2].textContent));
      } else if (categoryFilter === "durationdesc") {
        rowsArray.sort((a, b) => b.cells[3].textContent.localeCompare(a.cells[3].textContent));
      } else if (categoryFilter === "durationasc") {
        rowsArray.sort((a, b) => a.cells[3].textContent.localeCompare(b.cells[3].textContent));
      }

      // Reorganiza as linhas na tabela
      let tableBody = document.querySelector("#atestadosTable tbody");
      rowsArray.forEach((row) => tableBody.appendChild(row));
    }

    // Adiciona eventos para filtrar instantaneamente
    document.getElementById("search").addEventListener("input", filterDocuments);
    document.getElementById("category").addEventListener("change", filterDocuments);

    $(".formAtestado").on("submit", function (e) {
      e.preventDefault(); // evita que a página recarregue

      let form = $(this)[0]; // pega o form HTML
      let formData = new FormData(form); // cria um FormData com os dados do form (inclusive o arquivo!)

      $.ajax({
        url: "/atestado/upload/",
        type: "POST",
        data: formData,
        processData: false, // impede que o jQuery processe os dados
        contentType: false, // deixa o browser decidir o tipo (multipart/form-data)
        success: function (response) {
          window.location.reload();
        },
        error: function (xhr, status, error) {
          console.error(xhr.responseText);
        },
      });
    });

    // Função para buscar e exibir os atestados em uma tabela
    function fetchAtestados() {
      $.ajax({
        url: "/atestado/lista/",
        type: "GET",
        success: function (response) {
          let tableBody = $("#atestadosTable tbody");
          tableBody.empty(); // Limpa a tabela antes de adicionar os dados

          response.forEach((atestado) => {
            let row = $(
              `<tr>
                <td><a href='${atestado.file_url}' target='_blank'>${atestado.name}</a></td>
                <td>${atestado.uploaded_by}</td>
                <td>${atestado.date}</td>
                <td>${atestado.duration} dias</td>
                <td>${atestado.filetype || ''}</td>
              </tr>`
            );
            tableBody.append(row);
          });
        },
        error: function (xhr, status, error) {
          console.error(xhr.responseText);
        },
      });
    }

    // Chama a função para buscar os atestados ao carregar a página
    fetchAtestados();

    // Função para calcular e exibir métricas
    function calcularMetricas(atestados) {
      // Contagem por tipo
      let tipos = {};
      let duracoes = {};
      let agora = new Date();
      let count7 = 0, count30 = 0, countTotal = atestados.length;
      atestados.forEach(a => {
        // Tipo
        if (a.filetype) tipos[a.filetype] = (tipos[a.filetype] || 0) + 1;
        // Duração
        let dur = (a.duration || '').toString().replace(/\D/g, '');
        if (dur) duracoes[dur] = (duracoes[dur] || 0) + 1;
        // Datas
        let data = new Date(a.date);
        let diff = (agora - data) / (1000 * 60 * 60 * 24);
        if (diff <= 7) count7++;
        if (diff <= 30) count30++;
      });
      // Tipo mais recebido
      let tipoMais = Object.entries(tipos).sort((a,b)=>b[1]-a[1])[0] || ["-",0];
      // Duração mais comum
      let durMais = Object.entries(duracoes).sort((a,b)=>b[1]-a[1])[0] || ["-",0];
      // Monta HTML em tabelas
      let html = `<h6>Tipo de atestado mais recebido: <b>${tipoMais[0]}</b> (${tipoMais[1]})</h6>`;
      html += `<table class='table table-bordered'><thead><tr><th>Tipo de Atestado</th><th>Quantidade</th></tr></thead><tbody>`;
      Object.entries(tipos).forEach(([tipo, qtd]) => {
        html += `<tr><td>${tipo}</td><td><b>${qtd}</b></td></tr>`;
      });
      html += `</tbody></table>`;
      html += `<h6>Duração mais comum: <b>${durMais[0]} dias</b> (${durMais[1]})</h6>`;
      html += `<table class='table table-bordered'><thead><tr><th>Duração (dias)</th><th>Quantidade</th></tr></thead><tbody>`;
      Object.entries(duracoes).forEach(([dur, qtd]) => {
        html += `<tr><td>${dur}</td><td><b>${qtd}</b></td></tr>`;
      });
      html += `</tbody></table>`;
      html += `<h6>Número de atestados enviados:</h6>`;
      html += `<table class='table table-bordered'><thead><tr><th>Período</th><th>Quantidade</th></tr></thead><tbody>`;
      html += `<tr><td>Últimos 7 dias</td><td><b>${count7}</b></td></tr>`;
      html += `<tr><td>Últimos 30 dias</td><td><b>${count30}</b></td></tr>`;
      html += `<tr><td>Todo o período</td><td><b>${countTotal}</b></td></tr>`;
      html += `</tbody></table>`;
      return html;
    }

    // Evento para abrir o modal e buscar métricas
    $('#modalMetricas').on('show.bs.modal', function () {
      $('#metricasConteudo').html('<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>');
      $.ajax({
        url: "/atestado/lista/",
        type: "GET",
        success: function (response) {
          $('#metricasConteudo').html(calcularMetricas(response));
        },
        error: function () {
          $('#metricasConteudo').html('<div class="alert alert-danger">Erro ao carregar métricas.</div>');
        }
      });
    });
  });
</script>

{% endblock %}
