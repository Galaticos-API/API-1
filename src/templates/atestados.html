<!-- templates/atestados.html -->
{% extends "base.html" %} {% block title %}Atestados{% endblock %} {% block content %}
<div class="content">
  <h1>Atestados</h1>
  <hr />
  <h4>Envio de documento</h4>
  <form class="formAtestado row my-3" id="formAtestadoJ" method="POST" enctype="multipart/form-data">
    <div class="col-md-4 col-12">
      <label for="inputGroupFile02" class="form-label">Selecionar arquivo</label>
      <div class="input-group mb-3">
        <input class="form-control" type="file" name="file" id="file" accept=".pdf" required />
      </div>
    </div>
    <div class="col-md-4 col-6">
      <label for="duration" class="form-label">Duração do Atestado (em dias)</label>
      <div class="input-group">
        <input type="text" class="form-control" name="duration" id="duration" />
      </div>
    </div>
    <div class="col-md-4 col-6">
      <label for="filetype" class="form-label">Tipo de atestado</label>
      <div class="input-group mb-3">
        <select class="form-select" id="filetype" name="filetype">
          <option value="undefined">Selecione um tipo</option>
          <option value="TIPO1">TIPO1</option>
          <option value="TIPO2">TIPO2</option>
          <option value="TIPO3">TIPO3</option>
        </select>
      </div>
    </div>
    <button class="btn btn-outline-primary col-md-4 col-6 mx-2 mb-3" id="botao-do-submit" type="submit">Enviar</button>
  </form>

  <hr />
  <h4>Atestados enviados</h4>
  <nav class="search-container mb-3">
    <input type="number" id="search" placeholder="Buscar por RA..." oninput="filterDocuments()" />
    <select id="category" onchange="filterDocuments()">
      <option value="durationasc">Menor Duração</option>
      <option value="durationdesc">Maior Duração</option>
      <option value="dateolder">Mais Antigo</option>
      <option value="datenewer">Mais Recente</option>
    </select>
  </nav>

  <table id="atestadosTable" class="table table-striped px-0">
    <thead>
      <tr>
        <th>Nome do Documento</th>
        <th>RA do Aluno</th>
        <th>Data de Envio</th>
        <th>Duração do Atestado</th>
        <th>Abrir o Arquivo</th>
      </tr>
    </thead>
    <tbody>
      <!-- Os dados dos atestados serão inseridos aqui -->
    </tbody>
  </table>
</div>

<script>
  $(document).ready(function () {
    function filterDocuments() {
      let searchInput = document.getElementById("search").value.toLowerCase();
      let categoryFilter = document.getElementById("category").value;
      let rows = document.querySelectorAll("#atestadosTable tbody tr");

      // Converte as linhas para um array para facilitar a ordenação
      let rowsArray = Array.from(rows);

      // Filtro de busca por RA
      rowsArray.forEach((row) => {
        let ra = row.cells[1].textContent.toLowerCase();
        row.style.display = ra.includes(searchInput) ? "" : "none";
      });

      // Ordenação com base no filtro selecionado
      if (categoryFilter === "nameaz") {
        rowsArray.sort((a, b) => a.cells[0].textContent.localeCompare(b.cells[0].textContent));
      } else if (categoryFilter === "nameza") {
        rowsArray.sort((a, b) => b.cells[0].textContent.localeCompare(a.cells[0].textContent));
      } else if (categoryFilter === "dateolder") {
        rowsArray.sort((a, b) => new Date(a.cells[2].textContent) - new Date(b.cells[2].textContent));
      } else if (categoryFilter === "datenewer") {
        rowsArray.sort((a, b) => new Date(b.cells[2].textContent) - new Date(a.cells[2].textContent));
      } else if (categoryFilter === "durationdesc") {
        rowsArray.sort((a, b) => b.cells[3].textContent.localeCompare(a.cells[3].textContent));
      } else if (categoryFilter === "durationasc") {
        rowsArray.sort((a, b) => a.cells[3].textContent.localeCompare(b.cells[3].textContent));
      }

      // Reorganiza as linhas na tabela
      let tableBody = document.querySelector("#atestadosTable tbody");
      rowsArray.forEach((row) => tableBody.appendChild(row));
    }

    // Adiciona eventos para filtrar instantaneamente
    document.getElementById("search").addEventListener("input", filterDocuments);
    document.getElementById("category").addEventListener("change", filterDocuments);

    $(".formAtestado").on("submit", function (e) {
      e.preventDefault(); // evita que a página recarregue

      let form = $(this)[0]; // pega o form HTML
      let formData = new FormData(form); // cria um FormData com os dados do form (inclusive o arquivo!)

      $.ajax({
        url: "/atestado/upload/",
        type: "POST",
        data: formData,
        processData: false, // impede que o jQuery processe os dados
        contentType: false, // deixa o browser decidir o tipo (multipart/form-data)
        success: function (response) {
          window.location.reload();
        },
        error: function (xhr, status, error) {
          console.error(xhr.responseText);
        },
      });
    });

    // Função para buscar e exibir os atestados em uma tabela
    function fetchAtestados() {
      $.ajax({
        url: "/atestado/lista/",
        type: "GET",
        success: function (response) {
          let tableBody = $("#atestadosTable tbody");
          tableBody.empty(); // Limpa a tabela antes de adicionar os dados

          response.forEach((atestado) => {
            let row = $(
              `<tr>
                <td>${atestado.name}</td>
                <td>${atestado.uploaded_by}</td>
                <td>${atestado.date}</td>
                <td>${atestado.duration} dias</td>
                <td><a href='${atestado.file_url}' target='_blank'>Visualizar</a></td>
              </tr>`
            );
            tableBody.append(row);
          });
        },
        error: function (xhr, status, error) {
          console.error(xhr.responseText);
        },
      });
    }

    // Chama a função para buscar os atestados ao carregar a página
    fetchAtestados();
  });
</script>

{% endblock %}
